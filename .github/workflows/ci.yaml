name: Continuous Integration and Deployment

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  ENVIRONMENT: ${{ (github.head_ref || github.ref_name) == 'main' && 'production' || 'preview' }}

permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
      - name: Run linting
        run: pnpm lint

  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
      - name: Build application
        run: pnpm build

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
      - name: Run type checking
        run: pnpm tsc --noEmit

  unit-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
      - name: Run unit tests with coverage
        run: pnpm test:unit

  integration-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Playwright
        uses: ./.github/actions/setup-playwright
      - name: Run integration tests
        run: pnpm test:integration --grep "visual regression" --invert
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results/
          retention-days: 30

  visual-regression-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Playwright
        uses: ./.github/actions/setup-playwright
      - name: Run visual regression tests
        id: visual-tests
        run: pnpm test:integration --grep "visual regression"
        continue-on-error: true
      - name: Check for visual differences
        id: check-diff
        run: |
          if [ -d "test-results" ] && [ "$(find test-results -name "*-diff.png" | wc -l)" -gt 0 ]; then
            echo "differences=true" >> $GITHUB_OUTPUT
          else
            echo "differences=false" >> $GITHUB_OUTPUT
          fi
      - name: Process screenshots for display
        id: process-screenshots
        if: steps.check-diff.outputs.differences == 'true'
        run: |
          mkdir -p processed-screenshots

          # Create markdown for image comparisons
          echo "image_comparisons<<EOF" >> $GITHUB_OUTPUT

          for diff_file in $(find test-results -name "*-diff.png" 2>/dev/null || true); do
            if [ -f "$diff_file" ]; then
              base_name=$(basename "$diff_file" -diff.png)
              dir_name=$(dirname "$diff_file")
              expected_file="$dir_name/$base_name-expected.png"
              actual_file="$dir_name/$base_name-actual.png"
              
              # Copy files with simpler names for easier reference
              cp "$expected_file" "processed-screenshots/${base_name}-expected.png" 2>/dev/null || true
              cp "$actual_file" "processed-screenshots/${base_name}-actual.png" 2>/dev/null || true  
              cp "$diff_file" "processed-screenshots/${base_name}-diff.png" 2>/dev/null || true
              
              echo "### üîç $base_name"
              echo ""
              echo "| Expected | Actual | Difference |"
              echo "|----------|--------|------------|"
              echo "| ![Expected](https://github.com/${{ github.repository }}/suites/${{ github.run_id }}/artifacts/${base_name}-expected) | ![Actual](https://github.com/${{ github.repository }}/suites/${{ github.run_id }}/artifacts/${base_name}-actual) | ![Diff](https://github.com/${{ github.repository }}/suites/${{ github.run_id }}/artifacts/${base_name}-diff) |"
              echo ""
            fi
          done

          EOF
      - name: Upload screenshot artifacts
        uses: actions/upload-artifact@v4
        if: steps.check-diff.outputs.differences == 'true'
        with:
          name: visual-regression-screenshots
          path: |
            integration-tests/**/*-snapshots/
            test-results/
            processed-screenshots/
          retention-days: 7
      - name: Comment PR with visual regression results
        if: steps.check-diff.outputs.differences == 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: visual-regression-results
          message: |
            ## üì∏ Visual Regression Differences Detected

            Visual differences were found in the screenshot tests:

            ${{ steps.process-screenshots.outputs.image_comparisons }}

            **üìé Download All Screenshots**: [visual-regression-screenshots](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            <details>
            <summary>How to update baselines if changes are intentional</summary>

            ```bash
            pnpm test:integration --grep "visual regression" --update-snapshots
            ```
            </details>

  deploy:
    runs-on: ubuntu-latest
    needs: [lint, build, typecheck, unit-test, integration-test]
    environment: ${{ (github.head_ref || github.ref_name) == 'main' && 'production' || 'preview' }}

    steps:
      - name: Determine environment
        run: echo "Deploying to ${{ env.ENVIRONMENT }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=${{ env.ENVIRONMENT }} --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy production
        if: env.ENVIRONMENT == 'production'
        run: vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy preview
        if: env.ENVIRONMENT == 'preview'
        run: |
          PREVIEW_URL=$(vercel deploy --token=${{ secrets.VERCEL_TOKEN }})
          echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_ENV

      - name: Comment PR with preview URL
        if: env.ENVIRONMENT == 'preview'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            üöÄ **Preview deployment ready!**

            üìé **Preview URL**: ${{ env.PREVIEW_URL }}
